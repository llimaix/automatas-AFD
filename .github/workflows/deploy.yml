name: Deploy Frontend to EC2

on:
  push:
    branches: [main, front]
  workflow_dispatch:

env:
  IMAGE_NAME: automatas-afd-frontend
  CONTAINER_NAME: automatas-afd-frontend

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Build Docker image
      run: |
        echo "ðŸ”¨ Building Docker image..."
        docker build -t ${{ env.IMAGE_NAME }}:latest .
        echo "ðŸ’¾ Saving Docker image..."
        docker save ${{ env.IMAGE_NAME }}:latest > frontend-image.tar
        ls -lh frontend-image.tar
        
    - name: Copy files to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_PORT || 22 }}
        source: "frontend-image.tar,docker-compose.yml"
        target: "/tmp/automatas-deploy/"
        timeout: 300s
        
    - name: Deploy on server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_PORT || 22 }}
        timeout: 300s
        script: |
          set -e
          
          echo "ðŸš€ Starting deployment..."
          cd /tmp/automatas-deploy
          
          # Stop and remove existing containers
          echo "ðŸ›‘ Stopping existing services..."
          docker stop ${{ env.CONTAINER_NAME }} 2>/dev/null || true
          docker rm ${{ env.CONTAINER_NAME }} 2>/dev/null || true
          
          # Load new image
          echo "ðŸ“¦ Loading new Docker image..."
          docker load < frontend-image.tar
          
          # Start new container
          echo "ðŸš€ Starting new container..."
          docker compose up -d
          
          # Wait for container to be ready
          echo "â³ Waiting for container to be ready..."
          sleep 15
          
          # Verify deployment
          if docker ps | grep -q "${{ env.CONTAINER_NAME }}"; then
            echo "âœ… Container is running!"
            
            # Check health
            for i in {1..12}; do
              if curl -f -s http://localhost/ > /dev/null 2>&1; then
                echo "âœ… Application is responding!"
                break
              else
                echo "â³ Waiting for application to respond... ($i/12)"
                sleep 5
              fi
            done
            
            # Show container status
            echo "ðŸ“Š Container status:"
            docker ps --filter name=${{ env.CONTAINER_NAME }}
            
            # Show logs
            echo "ðŸ“‹ Recent logs:"
            docker logs ${{ env.CONTAINER_NAME }} --tail 10
            
            # Get public IP
            PUBLIC_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4 2>/dev/null || echo "your-server-ip")
            echo "ðŸŒ Application deployed successfully at: http://$PUBLIC_IP"
            
          else
            echo "âŒ Container failed to start!"
            echo "ðŸ“‹ Checking logs..."
            docker logs ${{ env.CONTAINER_NAME }} --tail 50 2>/dev/null || echo "No logs available"
            exit 1
          fi
          
          # Cleanup
          echo "ðŸ§¹ Cleaning up..."
          docker image prune -f > /dev/null 2>&1 || true
          rm -rf /tmp/automatas-deploy
          
          echo "ðŸŽ‰ Deployment completed successfully!"