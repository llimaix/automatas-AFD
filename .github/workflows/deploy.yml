name: Deploy Frontend to EC2 with Docker

on:
  push:
    branches: [ main, front ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build Docker image
      run: |
        docker build -t automatas-afd-frontend:latest .
        docker save automatas-afd-frontend:latest > frontend-image.tar
        
    - name: Copy files to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_PORT || 22 }}
        source: "frontend-image.tar,docker-compose.yml"
        target: "/tmp/automatas-deploy/"
        
    - name: Deploy with Docker on EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_PORT || 22 }}
        script: |
          echo "ğŸš€ Iniciando despliegue con Docker..."
          
          # Navegar al directorio de despliegue
          cd /tmp/automatas-deploy
          
          # Detener y remover contenedores existentes
          echo "ğŸ›‘ Deteniendo contenedores existentes..."
          docker compose down 2>/dev/null || true
          docker stop automatas-afd-frontend 2>/dev/null || true
          docker rm automatas-afd-frontend 2>/dev/null || true
          
          # Cargar la nueva imagen
          echo "ğŸ“¦ Cargando nueva imagen Docker..."
          docker load < frontend-image.tar
          
          # Limpiar imÃ¡genes antiguas
          echo "ğŸ§¹ Limpiando imÃ¡genes antiguas..."
          docker image prune -f
          
          # Iniciar el nuevo contenedor
          echo "ğŸš€ Iniciando nuevo contenedor..."
          docker compose up -d
          
          # Verificar que el contenedor estÃ© funcionando
          echo "âœ… Verificando estado del contenedor..."
          sleep 10
          
          if docker ps | grep -q automatas-afd-frontend; then
            echo "âœ… Contenedor iniciado exitosamente!"
            
            # Obtener IP pÃºblica
            PUBLIC_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4 2>/dev/null || echo "tu-ip-ec2")
            
            echo "ğŸŒ AplicaciÃ³n disponible en: http://$PUBLIC_IP"
            
            # Mostrar logs del contenedor
            echo "ğŸ“‹ Ãšltimos logs del contenedor:"
            docker logs automatas-afd-frontend --tail 20
            
            # Verificar respuesta HTTP
            if curl -f -s http://localhost/ > /dev/null; then
              echo "âœ… AplicaciÃ³n respondiendo correctamente!"
            else
              echo "âš ï¸ AplicaciÃ³n no responde en el puerto 80"
            fi
          else
            echo "âŒ Error: El contenedor no se iniciÃ³ correctamente"
            docker logs automatas-afd-frontend --tail 50
            exit 1
          fi
          
          # Limpiar archivos temporales
          rm -rf /tmp/automatas-deploy
          
          echo "ğŸ‰ Â¡Despliegue completado exitosamente!"